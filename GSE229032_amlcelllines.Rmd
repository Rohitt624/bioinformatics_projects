---
title: "GSE229032_AMLCellLine"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r packages}
library(tidyverse)
library(DESeq2)
library(rnaseqGene)
library(pheatmap)
library(ggalt)
library(fgsea)
library(biomaRt)
library(ggVennDiagram)
library(VennDiagram)
library(ggrepel)
setwd("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/TBK1 Project/RNAseq/GSE229032/")

EnsIDReplace2 <- function(input){
  gene_mapping <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/Ensembl_labels_human.csv")
  rnanames <- rownames(input)
  id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
  rnaname <- character(nrow(input))
  for (i in seq_len(nrow(input))) {
    ensembl_id <- rownames(input)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
  rnaname[rnaname == ""] <- NA
  
  rownames(input) <- make.names(rnaname, unique = TRUE)
  rm(gene_mapping, id_list, ensembl_id, i, rnaname)
}

run_gsea <- function(dds, condition1, condition2, gmt_path, output_gsea, output_deg) {
  res1 <- DESeq2::results(dds, 
                       contrast = c("condition", condition1, condition2),
                       independentFiltering = TRUE,
                       alpha = 0.1)
res1 <- subset(res1, padj < 0.1)
rnk <- setNames(res1$log2FoldChange, rownames(res1))
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
res1_filtered <- res1[complete.cases(res1), ]
write.csv(res1_filtered, output_deg)
}
```

```{r}
# Connect to Ensembl BioMart for human genes
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

# Retrieve Ensembl gene IDs and HGNC symbols
gene_mapping <- getBM(
  attributes = c("ensembl_gene_id", "hgnc_symbol"),
  mart = ensembl
)

# Rename columns to match your function's expectations
colnames(gene_mapping) <- c("gene_id", "gene_name")

# Save to CSV
write.csv(gene_mapping, "C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/Ensembl_labels_human.csv", row.names = FALSE)

```



```{r load dataset and ID replace}
cts <- read.csv("GSE229032_AML_Samples_RNASeq_Processed_counts_corrected.csv", row.names = 1)
rownames(cts) <- cts$Geneid
EnsIDReplace2(cts)
gene_mapping <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/Ensembl_labels_human.csv")
rnanames <- rownames(cts)
id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
rnaname <- character(nrow(cts))
for (i in seq_len(nrow(cts))) {
    ensembl_id <- rownames(cts)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
rnaname[rnaname == ""] <- NA
  
rownames(cts) <- make.names(rnaname, unique = TRUE)
rm(gene_mapping, id_list, ensembl_id, i, rnaname)
write.csv(cts, "aml_genename.csv")
aml <- cts
rm(cts)
```

```{r load into matrix}
aml <- read.csv("aml_genename.csv", row.names = 1)
cd <- read.csv("amlcoldata.csv", row.names = 1)
dds <- DESeqDataSetFromMatrix(countData = aml, colData = cd, design = ~condition)
dds <- DESeq(dds)
vst <- vst(dds, blind=FALSE)
rescmp <- results(dds) 

```

```{r subset patients}
patients <- c("P1006",	"P1021",	"P1044",	"P1065",	"P109",	"P1257",	"P1266",	"P1304",	"P1313",	"P1316",	"P1321",	"P1343",	"P1356",	"P1361",	"P136",	"P218",	"P801",	"P850",	"P933",	"P934",	"P998",	"PBL10261",	"PBL10278",	"PPBL10173",	"PPBL8426",	"PPBL9542",	"PPBL9785")
dds_patients <- dds[, colnames(dds) %in% patients] 
vst_mat <- assay(vst(dds_patients)) 
```

```{r order by tbk1}
tbk1_vec <- vst_mat["TBK1", ]

norm <- counts(dds_patients, normalized = TRUE) 
tbk1_vec <- norm["TBK1", ]

df <- data.frame( sample = names(tbk1_vec), tbk1 = as.numeric(tbk1_vec) ) 
df_ordered <- df %>% arrange(tbk1)

tbk1plot <- ggplot(df_ordered, aes(x = reorder(sample, tbk1), y = tbk1)) + 
  geom_col(fill = "steelblue") + 
  labs(title = "TBK1 Expression in Patient Samples", x = "Sample", y = "TBK1 Expression (normalized counts)") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
tbk1plot

ggsave("tbk1_patientsamples.png", dpi = 600)

q1 <- quantile(df_ordered$tbk1, 0.25) 
q3 <- quantile(df_ordered$tbk1, 0.75) 
bottom_quartile <- df_ordered %>% filter(tbk1 <= q1) 
top_quartile <- df_ordered %>% filter(tbk1 >= q3)

# Create a vector of sample names
top_samples <- top_quartile$sample
bottom_samples <- bottom_quartile$sample

# Initialize group column
dds_patients$TBK1_group <- NA

dds_patients$TBK1_group[colnames(dds_patients) %in% top_samples] <- "Top"
dds_patients$TBK1_group[colnames(dds_patients) %in% bottom_samples] <- "Bottom"

# Drop middle samples
dds_q <- dds_patients[, !is.na(dds_patients$TBK1_group)]

dds_q$TBK1_group <- factor(dds_q$TBK1_group, levels = c("Bottom", "Top"))

design(dds_q) <- ~ TBK1_group
dds_q$TBK1_group <- droplevels(dds_q$TBK1_group)
dds_q$TBK1_group <- factor(dds_q$TBK1_group, levels = c("Bottom", "Top"))
model.matrix(design(dds_q), colData(dds_q))

dds_q <- DESeq(dds_q)

res_tbk1 <- results(dds_q, contrast = c("TBK1_group", "Top", "Bottom"))
res_tbk1 <- res_tbk1[order(res_tbk1$padj), ]
head(res_tbk1)
```

```{r gsea}
rnk <- res_tbk1$log2FoldChange*(1-res_tbk1$padj)
names(rnk) <- rownames(res_tbk1)
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways("humangseapathways.gmt")
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, "tbk1_gsea_newrnk.csv")
gseadf_subset <- subset(gseadf, padj < 0.25)
write.csv(gseadf_subset, "tbk1gseafiltered.csv")
res1_filtered <- res_tbk1[complete.cases(res_tbk1), ]
write.csv(res1_filtered, "tbk1_deg.csv")

rnk <- res_tbk1$log2FoldChange*(1-res_tbk1$padj)
names(rnk) <- rownames(res_tbk1)
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways("LSC.gmt")
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, "lsc_gsea_.csv")
gseadf_subset <- subset(gseadf, padj < 0.25)
write.csv(gseadf_subset, "lscgseafiltered.csv")

```

```{r gsea plot}
tf <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/Kanak Tet2 Ripk3/output/202410083/finaltfolldtv2.csv")
tfplot <- ggplot(tf, aes(x=-log10(padj), y=reorder(NAME, -log10(padj)), fill = NES))
tfplot + geom_point(size=5, shape=21) + 
 theme(
    panel.background = element_rect(fill = "white"), 
    panel.border = element_rect(color = "black", fill = NA), 
    plot.title = element_text(hjust = 0.5), 
    axis.text=element_text(color="black", face="bold")
    ) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint=0, limits=c(-2.1,2.1)) + 
  labs(x="-log(FDR q value)", y="Genesets", title="T cell & Lymphoma Genesets") +
  xlim(0,5.1)

cc <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/Kanak Tet2 Ripk3/output/202410083/finalcellcycledtv2.csv")
ccplot <- ggplot(cc, aes(x=-log10(FDR.q.val+0.00001), y=reorder(NAME, -log10(FDR.q.val)), fill = NES))
ccplot + geom_point(size=5, shape=21) +  
 theme(
    panel.background = element_rect(fill = "white"), 
    panel.border = element_rect(color = "black", fill = NA), 
    plot.title = element_text(hjust = 0.5), 
    axis.text=element_text(color="black", face="bold")
    ) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint=0, limits=c(-2.2,2.2)) + 
  labs(x="-log(FDR q-value)", y="Genesets", title="Cell Cycle & Proliferation Genesets") +
  xlim(0,5.1)

my <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/Kanak Tet2 Ripk3/output/202410083/finalmyeloiddtv2.csv")
myplot <- ggplot(my, aes(x=-log10(FDR.q.val+0.00001), y=reorder(NAME, -log10(FDR.q.val)), fill = NES))
myplot + geom_point(size=5, shape=21) +  
 theme(
    panel.background = element_rect(fill = "white"), 
    panel.border = element_rect(color = "black", fill = NA), 
    plot.title = element_text(hjust = 0.5), 
    axis.text=element_text(color="black", face="bold")
    ) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint=0, limits=c(-2.0,2.0)) + 
  labs(x="-log(FDR q-value)", y="Genesets", title="Myeloid Genesets") +
  xlim(0,5.1)
```

```{r tbk1 tak1 regression}
vst_mat <- assay(vst(dds_patients))
norm_counts <- counts(dds_patients, normalized = TRUE)

df_scatter <- data.frame(
  sample = colnames(norm_counts),
  TBK1 = as.numeric(norm_counts["TBK1", ]),
  MAP3K7 = as.numeric(norm_counts["MAP3K7", ])
)

fit <- lm(MAP3K7 ~ TBK1, data = df_scatter)

intercept <- coef(fit)[1]
slope <- coef(fit)[2]

r2 <- summary(fit)$r.squared
pval <- summary(fit)$coefficients[2, 4]

label_text <- paste0(
  "R² = ", round(r2, 3), 
  "\nP = ", signif(pval, 3)
)

scatter <- ggplot(df_scatter, aes(x = TBK1, y = MAP3K7)) +
  geom_point(size = 3, color = "steelblue") +
  geom_abline(intercept = intercept, slope = slope, color = "darkred", size = 1) +
  annotate("text", 
           x = min(df_scatter$TBK1), 
           y = max(df_scatter$MAP3K7), 
           label = label_text, 
           hjust = 0, vjust = 1, size = 5) +
  labs(
    title = "TBK1 vs MAP3K7 Expression (Patient Samples)",
    x = "TBK1 Expression (VST)",
    y = "MAP3K7 Expression (VST)"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )

ggsave("tbk1tak1scatter.png", scatter, dpi = 600)

```

```{r tbk1 tak1 regression no outlier}
norm_counts <- counts(dds_patients, normalized = TRUE)

df_scatter <- data.frame(
  sample = colnames(norm_counts),
  TBK1 = as.numeric(norm_counts["TBK1", ]),
  MAP3K7 = as.numeric(norm_counts["MAP3K7", ])
)

Q1 <- quantile(df_scatter$TBK1, 0.25)
Q3 <- quantile(df_scatter$TBK1, 0.75)
IQR <- Q3 - Q1

upper_cutoff <- Q3 + 1.5 * IQR

df_no_outlier <- df_scatter %>% filter(TBK1 <= upper_cutoff)

fit2 <- lm(MAP3K7 ~ TBK1, data = df_no_outlier)

intercept2 <- coef(fit2)[1]
slope2 <- coef(fit2)[2]

r2_2 <- summary(fit2)$r.squared
pval_2 <- summary(fit2)$coefficients[2, 4]

label_text2 <- paste0(
  "R² = ", round(r2_2, 3),
  "\nP = ", signif(pval_2, 3)
)

ggplot(df_no_outlier, aes(x = TBK1, y = MAP3K7)) +
  geom_point(size = 3, color = "steelblue") +
  geom_abline(intercept = intercept2, slope = slope2, color = "darkred", size = 1) +
  annotate(
    "text",
    x = min(df_no_outlier$TBK1),
    y = max(df_no_outlier$MAP3K7),
    label = label_text2,
    hjust = 0, vjust = 1, size = 5
  ) +
  labs(
    title = "TBK1 vs MAP3K7 (Outlier Removed)",
    x = "TBK1 (normalized counts)",
    y = "MAP3K7 (normalized counts)"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  )

```

```{r Heatmap of Specific Genes}
#genelist only
genelist <- c("TBK1", "RIPK1", "MAP3K7")


mat <- assay(vst)
vst_subset <- mat[rownames(mat) %in% genelist, ]

#genelist and cell line
cell_lines <- c("MOLM13", "HL60", "MONOMAC6", "ML2", "THP1", "U937")
cell_lines <- grep("MOLM13|MONOMAC6|ML2|THP1|U937", colnames(vst), value = TRUE)
vst_subset <- mat[rownames(mat) %in% genelist,
                         colnames(mat) %in% cell_lines]
tbk1_vals <- vst_subset["TBK1", ]
ordered_cols <- names(sort(tbk1_vals, decreasing = TRUE))
vst_subset_ordered <- vst_subset[, ordered_cols]
vst_subset_ordered <- t(vst_subset_ordered)

vst_subset <- assay(vst)[genelist, colnames(vst) %in% cell_lines]

# Define color palette
color_palette <- colorRampPalette(c("blue", "white", "red"))(100)

# Create a heatmap
heatmap <- pheatmap(vst_subset_ordered, 
         cluster_rows = FALSE, 
         cluster_cols = FALSE, 
         color = color_palette,
         show_rownames = TRUE, 
         show_colnames = TRUE,
         main = "Heatmap",
         treeheight_row = 0,
         cellwidth = 30,
         cellheight = 30)
heatmap
ggsave("tbk1_noscale.png", width = 3, height = 5, heatmap, dpi = 600)

```

```{r}
library(tidyverse)

# Extract VST values for your genes and cell lines
vst_subset <- assay(vst)[genelist, colnames(vst) %in% cell_lines]

# Convert to long format for ggplot
df <- vst_subset %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "cell_line", values_to = "expression")

tbk1_plot <- df %>%
  filter(gene == "TBK1") %>%
  ggplot(aes(x = cell_line, y = expression, fill = cell_line)) +
  geom_col(width = 0.7) +
  theme_bw(base_size = 16) +
  labs(title = "TBK1 Expression Across AML Cell Lines",
       x = "Cell Line",
       y = "VST Expression") +
  theme(legend.position = "none")
tbk1_plot

ripk1_plot <- df %>%
  filter(gene == "RIPK1") %>%
  ggplot(aes(x = cell_line, y = expression, fill = cell_line)) +
  geom_col(width = 0.7) +
  theme_bw(base_size = 16) +
  labs(title = "RIPK1 Expression Across AML Cell Lines",
       x = "Cell Line",
       y = "VST Expression") +
  theme(legend.position = "none")
ripk1_plot


```
