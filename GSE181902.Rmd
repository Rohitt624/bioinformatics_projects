---
title: "GSE181902"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


# Set Up

### Loading in required packages
```{r libraries, results='hide'}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(biomaRt)
library(pheatmap)
library(fgsea)
library(patchwork)
library(scales)
library(ggbreak)
library(ggcyto)
library(DESeq2)
options(future.globals.maxSize = 5000 * 1024^2)
setwd("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/GSE181902")

run_gsea <- function(markers, gmt_path, output_gsea) {
rnk <- setNames(markers$avg_log2FC, rownames(markers))
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
}

EnsIDReplace2 <- function(input, output){
  gene_mapping <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/Ensembl_labels.csv")
  rna <- input
  rnanames <- rownames(rna)
  id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
  rnaname <- character(nrow(rna))
  for (i in seq_len(nrow(rna))) {
    ensembl_id <- rownames(rna)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
  rnaname[rnaname == ""] <- NA
  
  rownames(rna) <- rnaname
  output <- rna
  rm(gene_mapping, id_list, ensembl_id, i, rnaname)
}
```


# Load the dataset and create Seurat Object with two assays

```{r load-data}
data <- Read10X("EY003_cellranger_count_outs/filtered_feature_bc_matrix/")
mpp3 <- CreateSeuratObject(data)
```

```{r cluster}
mpp3 <- NormalizeData(object = mpp3)
mpp3 <- FindVariableFeatures(object = mpp3)
mpp3 <- ScaleData(object = mpp3)
mpp3 <- RunPCA(object =mpp3)
mpp3 <- FindNeighbors(object =mpp3, dims = 1:30)
mpp3 <- FindClusters(object =mpp3)
mpp3 <- RunUMAP(object =mpp3, dims = 1:30)

rownames(mpp3)
```

```{r}
DimPlot(mpp3)
FeaturePlot(mpp3, features = c("Fcgr3"), cols = c("gray", "blue", "red"))
Idents(mpp3) <- "seurat_clusters"
VlnPlot(mpp3, features = c("Fcgr3"))

esam <- FetchData(mpp3, vars = c("Esam"))
esam <- subset(esam, esam$Esam > 0)
mpp3$esam <- ifelse(esam$Esam > 0, "Esam+", "Esam-")

Idents(mpp3) <- "esam"
DimPlot(mpp3)
```

```{r}
esammarkers <- FindMarkers(mpp3, ident.1 = "Esam+", ident.2 = "Esam-")
run_gsea(esammarkers, "reactome_go_gsea.gmt", "esam_gsea.csv")
write.csv(esammarkers, "esam_degs.csv")

Idents(mpp3) <- "seurat_clusters"
allmarkers <- FindAllMarkers(mpp3)
write.csv(allmarkers, "allmarkers.csv")
```

```{r ESAM pos and neg gene signature}
bulkdeg <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/MPP3 RNA Seq/Output/mpp3_deg.csv", row.names = 1)
gse145491deg <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/20250127_regate_mpp3_esam.csv", row.names = 1)

posbulkdeg <- subset(bulkdeg, bulkdeg$log2FoldChange > 0)
negbulkdeg <- subset(bulkdeg, bulkdeg$log2FoldChange < 0)

posgsedeg <- subset(gse145491deg, gse145491deg$avg_log2FC > 0)
neggsedeg <- subset(gse145491deg, gse145491deg$avg_log2FC < 0)

toppbd <- posbulkdeg[order(posbulkdeg$padj),][1:100,]
toppgd <- posgsedeg[order(posgsedeg$p_val_adj),][1:100,]
posoverlap <- intersect(rownames(toppbd), rownames(toppgd))
write.csv(posoverlap, "esampossignature.csv")

botpbd <- negbulkdeg[order(negbulkdeg$padj),][1:200,]
botpgd <- neggsedeg[order(neggsedeg$p_val_adj),][1:200,]
negoverlap <- intersect(rownames(botpbd), rownames(botpgd))
write.csv(negoverlap, "esamnegsignature.csv")
```

```{r module scores}
mpp3 <- AddModuleScore(mpp3, features = list(posoverlap), name = "Esam pos signature")
FeaturePlot(mpp3, 
            features = "Esam pos signature1")

mpp3 <- AddModuleScore(mpp3, features = list(negoverlap), name = "Esam neg signature")
FeaturePlot(mpp3, 
            features = "Esam neg signature1")

VlnPlot(mpp3, features = "Esam neg signature1")
VlnPlot(mpp3, features = "Esam pos signature1")

```

```{r rename clusters and do gsea}
mpp3$esam2 <- NA
mpp3$esam2[mpp3$seurat_clusters %in% c(0, 6, 9)] <- "ESAM Positive"
mpp3$esam2[mpp3$seurat_clusters %in% c(1, 2, 3, 4, 5)] <- "ESAM Negative"
mpp3$esam2[mpp3$seurat_clusters %in% c(7, 8)] <- "Intermediate"

DimPlot(mpp3)
Idents(mpp3) <- "esam2"
newesammarkers <- FindAllMarkers(mpp3)
newesammarkersfiltered <- subset(newesammarkers, newesammarkers$p_val_adj < 0.1)
write.csv(newesammarkersfiltered, "newesammarkers_filtered.csv")
esamposmarkers <- subset(newesammarkers, newesammarkers$cluster == "ESAM Positive")
esamnegmarkers <- subset(newesammarkers, newesammarkers$cluster == "ESAM Negative")
esamintmarkers <- subset(newesammarkers, newesammarkers$cluster == "Intermediate")

run_gsea(esamposmarkers, "reactome_go_gsea.gmt", "esamposgsea.csv")
run_gsea(esamnegmarkers, "reactome_go_gsea.gmt", "esamneggsea.csv")
run_gsea(esamintmarkers, "reactome_go_gsea.gmt", "esamintgsea.csv")
```

```{r esam pos vs neg gsea}
posnegmarkers <- FindMarkers(mpp3, ident.1 = "ESAM Positive", ident.2 = "ESAM Negative")
write.csv(posnegmarkers, "esamposnegmarkers.csv")
run_gsea(posnegmarkers, "reactome_go_gsea.gmt", "esamposneggsea.csv")
```


```{r Bar Chart}
esam <- FetchData(seurat_object, vars = c("seurat_clusters", "adt_ESAM"))
esam <- data.frame(Cell = rownames(esam), Cluster = esam$seurat_clusters, ESAM = esam$adt_ESAM)
esam <- esam[order(esam$Cluster),]
esam$Cell <- factor(esam$Cell, levels = esam$Cell)

esambar <- ggplot(esam, aes(x = Cell, y = ESAM, fill = as.factor(Cluster))) + 
    geom_bar(stat = "identity", width = 1) +
  theme(
    axis.text = element_blank(), 
    axis.title = element_blank(), 
    axis.ticks = element_blank(), 
    legend.position = "none",
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1)
  )
 

cd9 <- FetchData(seurat_object, vars = c("seurat_clusters", "adt_CD9"))
cd9 <- data.frame(Cell = rownames(cd9), Cluster = cd9$seurat_clusters, CD9 = cd9$adt_CD9)
cd9 <- cd9[order(cd9$Cluster),]
cd9$Cell <- factor(cd9$Cell, levels = cd9$Cell)

cd9bar <- ggplot(cd9, aes(x = Cell, y = CD9, fill = as.factor(Cluster))) + 
    geom_bar(stat = "identity") + 
  theme(
    axis.text = element_blank(), 
    axis.title = element_blank(), 
    axis.ticks = element_blank(), 
    legend.position = "none",
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1)
  )

barchart <- esambar / cd9bar

esambar

barchart  

```


```{r Heatmap}
genelists <- read.csv("heatmapgenes.csv")
esampos <- FetchData(mpp3, vars = genelists$Esam)
esampos$clusters <- mpp3@meta.data$seurat_clusters
esamneg <- FetchData(mpp3, vars = genelists$Esam)
esamneg$clusters <- mpp3@meta.data$seurat_clusters

counts <- GetAssayData(mpp3, slot = "counts")
dds <- DESeqDataSetFromMatrix(counts, mpp3@meta.data, design = ~ 1)
vst <- varianceStabilizingTransformation(dds, blind = TRUE)
vst <- assay(vst)
mpp3[["vst"]] <- CreateAssayObject(counts = vst)

DefaultAssay(mpp3) <- "vst"
mpp3 <- ScaleData(mpp3, assay = "vst")

mpp3$seurat_clusters <- factor(mpp3$seurat_clusters, levels = c(0, 6, 9, 7, 8, 1, 2, 3, 4, 5))

newclusters <- c(10, 1, 2, 4, 3, 5, 9, 6, 7, 8)
clusters <- Idents(mpp3)
names(newclusters) <- levels(clusters)
mpp3 <- RenameIdents(mpp3, newclusters)
mpp3$newclusters <- Idents(mpp3)
mpp3$newclusters <- factor(mpp3$newclusters, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))
DimPlot(mpp3, group.by = "newclusters")

# Create a heatmap
DoHeatmap(
  object = mpp3,
  features = genelists$list,
  group.by = "newclusters"
) + scale_fill_gradientn(colors = c("blue", "white", "red"))


```