---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r libraries, results='hide'}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(biomaRt)
library(pheatmap)
library(fgsea)
library(patchwork)
library(scales)
library(ggbreak)
library(ggcyto)
library(DESeq2)
options(future.globals.maxSize = 5000 * 1024^2)
setwd("C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/MDS Project/RNA Seq/GSE263300/")

run_gsea <- function(markers, gmt_path, output_gsea) {
rnk <- setNames(markers$avg_log2FC, rownames(markers))
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 10, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
}

run_gsea_seu <- function(markers, gmt_path, output_gsea) {
rnk <- setNames(markers$avg_log2FC, markers$gene)
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 10, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
}

EnsIDReplace2 <- function(input, output){
  gene_mapping <- read.csv("C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/Ensembl_labels.csv")
  rna <- input
  rnanames <- rownames(rna)
  id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
  rnaname <- character(nrow(rna))
  for (i in seq_len(nrow(rna))) {
    ensembl_id <- rownames(rna)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
  rnaname[rnaname == ""] <- NA
  
  rownames(rna) <- rnaname
  output <- rna
  rm(gene_mapping, id_list, ensembl_id, i, rnaname)
}
```

```{r load data}
expr <- read.csv("expression_matrix.csv", row.names = 1)
cell.meta <- read.csv("cell_metadata.csv", row.names = 1)
so <- CreateSeuratObject(counts = expr, meta.data = cell.meta)
rm(expr, cell.meta)
```

```{r Process SO}
so <- NormalizeData(so)
so <- FindVariableFeatures(so)
so <- ScaleData(so)
so <- RunPCA(so)
so <- FindNeighbors(so, dims = 1:30)
so <- FindClusters(so, resolution = 0.8)
so <- RunUMAP(so, dims = 1:30)
```

seuratobject rdata file has already run through this point

```{r Visualize}
umap <- DimPlot(so, group.by = "seurat_clusters")
ggsave("umap_cluster.png", plot = umap, dpi = 600)

umap_label <- DimPlot(so, group.by = "label")
umap_label
ggsave("umap_label.png", plot = umap_label, dpi = 600)
```

SLAMF1 = CD150
ENG = CD105
TFRC = CD71


```{r Cluster Identification}
deg <- FindAllMarkers(so)
write.csv(deg, "clustermarkers.csv")

hsc <- c("AVP", "HLF", "PROM1")
hspc <- c("CD34", "PROM1")
gmp <- c("MPO", "ELANE", "S100A8", "S100A9")
mep <- c("TFRC", "KLF1", "GATA1")
mk <- c("PF4", "ITGA2B", "GP9")
mast <- c("MITF", "KIT", "KRT1")
eobp <- c("IL3RA", "IL5RA", "FCER1A")
genesets <- list(hsc = hsc,
                 hspc = hspc,
                 gmp = gmp,
                 mep = mep,
                 mk = mk,
                 mast = mast,
                 eobp = eobp)

write.csv(genesets, "celltypelabels.csv")

for (name in names(genesets)) {
  so <- AddModuleScore(so, features = list(genesets[[name]]), name = name)
}

cluster_ids <- levels(so$seurat_clusters)
scores <- sapply(names(genesets), function(name) {
  score_col <- paste0(name, "1")
  tapply(so[[score_col]][,1], so$seurat_clusters, mean)
})
scores <- as.data.frame(scores)
rownames(scores) <- cluster_ids

pheatmap(scores,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         scale = "row",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         treeheight_row = 0,
         treeheight_col = 0,
         main = "Module Score Heatmap",
         filename = "modulescoreheatmap.png")

so$label <- NA
so$label[so$seurat_clusters %in% c(2, 5, 14)] <- "HSC/HSPC"
so$label[so$seurat_clusters %in% c(12, 3, 10)] <- "MEP/Erythroid"
so$label[so$seurat_clusters %in% c(16, 18)] <- "MEP/MK"
so$label[so$seurat_clusters %in% c(13, 15, 4, 6)] <- "EoBP"
so$label[so$seurat_clusters %in% c(11, 19, 7)] <- "GMP"
so$label[so$seurat_clusters %in% c(8, 17, 1, 0, 9)] <- "Mast"
Idents(so) <- "label"

FeatureScatter(so, feature1 = c("MAP3K7"), feature2 = c("RIPK1")) + 
  scale_x_flowjo_biexp() + 
  scale_y_flowjo_biexp()

# Step 1: create a combined grouping factor
so$group <- paste(so$label, so$dataset, sep = "_")

# Step 2: run pseudobulk expression for MAP3K7
tak1 <- PseudobulkExpression(
  so,
  assay = "RNA",
  group.by = "group",
  features = "MAP3K7"
)

# Step 3: convert to a tidy table with cluster and dataset split out
expr_table <- data.frame(
  cluster = sapply(strsplit(rownames(tak1), "_"), `[`, 1),
  dataset = sapply(strsplit(rownames(tak1), "_"), `[`, 2),
  expression = tak1[, "MAP3K7"]
)
write.csv(tak1, "tak1_expr.csv")
```

```{r subset and recluster erythroid}
ery <- subset(so, so$label == c("MEP/Erythroid"))
ery <- NormalizeData(ery)
ery <- FindVariableFeatures(ery)
ery <- ScaleData(ery)
ery <- RunPCA(ery)
ery <- FindNeighbors(ery, dims = 1:30)
ery <- FindClusters(ery, resolution = 0.8)
ery <- RunUMAP(ery, dims = 1:30)

# 1. Run SCTransform and create a new assay (e.g. "sct")
ery <- SCTransform(
  ery,
  assay = "RNA",         # or whichever assay holds raw counts
  new.assay.name = "sct",
  vars.to.regress = NULL,  # add regressors if needed
  verbose = FALSE
)

# 2. Switch default assay to "sct"
DefaultAssay(ery) <- "sct"

# 3. Fetch normalized expression for your genes
expr_data <- FetchData(ery, vars = c("cluster_dataset", genes))

DimPlot(ery, split.by = "dataset")

Idents(ery) <- "dataset"
erymarkers <- FindMarkers(ery, ident.1 = "SF3B1", ident.2 = "AAVS")


hsc <- subset(so, so$label == c("HSC/HSPC"))
hsc <- NormalizeData(hsc)
hsc <- FindVariableFeatures(hsc)
hsc <- ScaleData(hsc)
hsc <- RunPCA(hsc)
hsc <- FindNeighbors(hsc, dims = 1:30)
hsc <- FindClusters(hsc, resolution = 0.8)
hsc <- RunUMAP(hsc, dims = 1:30)

DimPlot(hsc, split.by = "label")

Idents(hsc) <- "dataset"
hscmarkers <- FindMarkers(hsc, ident.1 = "SF3B1", ident.2 = "AAVS")

write.csv(erymarkers, "sf3b1_ery_deg.csv")
write.csv(hscmarkers, "sf3b1_hsc_deg.csv")

Idents(ery) <- "seurat_clusters"
ery$splitcluster <- paste(ery$seurat_clusters, ery$dataset, sep = "_")
Idents(ery) <- "splitcluster"
erydeg <- FindAllMarkers(ery)
Idents(hsc) <- "seurat_clusters"
hsc$splitcluster <- paste(hsc$seurat_clusters, hsc$dataset, sep = "_")
Idents(hsc) <- "splitcluster"
hscdeg <- FindAllMarkers(hsc)

write.csv(erydeg, "clustermarker_ery.csv")
write.csv(hscdeg, "clustermarker_hsc.csv")

Idents(ery) <- "seurat_clusters"
erycluster <- FindAllMarkers(ery)
Idents(hsc) <- "seurat_clusters"
hsccluster <- FindAllMarkers(hsc)
```

```{r sf3b1 deg}
# Add -log10 adjusted p-value
erymarkers$neglog10p <- -log10(erymarkers$p_val_adj)

# Volcano plot
eryvol <- ggplot(erymarkers, aes(x = avg_log2FC, y = neglog10p)) +
  geom_point(color = "gray") +
  geom_point(data = erymarkers["MAP3K7", , drop = FALSE],
             aes(x = avg_log2FC, y = neglog10p),
             color = "red", size = 3) +
  geom_text(data = erymarkers["MAP3K7", , drop = FALSE],
            aes(x = avg_log2FC, y = neglog10p, label = "MAP3K7"),
            vjust = -1, color = "red") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "blue") +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "green") +
  labs(title = "Erythroid SF3B1 vs AAVS",
       x = "Log2 Fold Change", y = "-Log10 Adjusted P-value")

ggsave("ery_tak1_volcano.png", plot = eryvol, dpi = 600)

# Add -log10 adjusted p-value
hscmarkers$neglog10p <- -log10(hscmarkers$p_val_adj)

# Volcano plot
hscvol <- ggplot(hscmarkers, aes(x = avg_log2FC, y = neglog10p)) +
  geom_point(color = "gray") +
  geom_point(data = hscmarkers["MAP3K7", , drop = FALSE],
             aes(x = avg_log2FC, y = neglog10p),
             color = "red", size = 3) +
  geom_text(data = hscmarkers["MAP3K7", , drop = FALSE],
            aes(x = avg_log2FC, y = neglog10p, label = "MAP3K7"),
            vjust = -1, color = "red") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "blue") +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "green") +
  labs(title = "HSC/HSPC SF3B1 vs AAVS",
       x = "Log2 Fold Change", y = "-Log10 Adjusted P-value")

ggsave("hsc_tak1_volcano.png", plot = hscvol, dpi = 600)

```

```{r label erythroid}
erymarker <- read.csv("ErythroidMarkers.csv")

genesets <- list(BFU_E = erymarker$BFUE,
                 CFU_E = erymarker$CFUE,
                 ProE = erymarker$ProE,
                 BasoE = erymarker$BasoE,
                 PolyE = erymarker$PolyE,
                 OrthoE = erymarker$OrthoE)

for (name in names(genesets)) {
  ery <- AddModuleScore(ery, features = list(genesets[[name]]), name = name)
}

cluster_ids <- levels(ery$seurat_clusters)
scores <- sapply(names(genesets), function(name) {
  score_col <- paste0(name, "1")
  tapply(ery[[score_col]][,1], ery$seurat_clusters, mean)
})
scores <- as.data.frame(scores)
rownames(scores) <- cluster_ids

ery <- SCTransform(
  ery,
  assay = "RNA",         # or whichever assay holds raw counts
  new.assay.name = "sct",
  vars.to.regress = NULL,  # add regressors if needed
  verbose = FALSE
)

# 2. Switch default assay to "sct"
DefaultAssay(ery) <- "RNA"

RidgePlot(ery, features = "CFU_E1")

pheatmap(scores,
         cluster_rows = TRUE,
         cluster_cols = FALSE,
         scale = "row",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         treeheight_row = 0,
         treeheight_col = 0,
         main = "Module Score Heatmap",
         filename = "modulescoreheatmap_ery2.png")

FeaturePlot(ery, features = "ProE1")

```

```{r label erythroid in hspc}

for (name in names(genesets)) {
  hsc <- AddModuleScore(hsc, features = list(genesets[[name]]), name = name)
}

cluster_ids <- levels(hsc$seurat_clusters)
scores <- sapply(names(genesets), function(name) {
  score_col <- paste0(name, "1")
  tapply(hsc[[score_col]][,1], hsc$seurat_clusters, mean)
})
scores <- as.data.frame(scores)
rownames(scores) <- cluster_ids

pheatmap(scores,
         cluster_rows = TRUE,
         cluster_cols = FALSE,
         scale = "column",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         treeheight_row = 0,
         treeheight_col = 0,
         main = "Module Score Heatmap",
         filename = "modulescoreheatmap_hsc2.png")



```


```{r sf3b1 deg}
Idents(ery) <- "dataset"
sf3b1markers <- FindMarkers(ery, ident.1 = "SF3B1", ident.2 = "AAVS")
sf3b1markers <- subset(sf3b1markers, sf3b1markers$p_val_adj < 0.1)
run_gsea(sf3b1markers, "reactome_go_gsea.gmt", "ery_sf3b1_gsea.csv")
write.csv(sf3b1markers, "ery_sf3b1_degs.csv")
```

```{r DEG dot plot}


degplot <- ggplot(tf, aes(x=-log10(FDR.q.val+0.00001), y=reorder(NAME, -log10(FDR.q.val)), fill = NES))
degplot + geom_point(size=5, shape=21) + 
 theme(
    panel.background = element_rect(fill = "white"), 
    panel.border = element_rect(color = "black", fill = NA), 
    plot.title = element_text(hjust = 0.5), 
    axis.text=element_text(color="black", face="bold")
    ) +
  scale_fill_gradient2(low="blue", mid="white", high="red", midpoint=0, limits=c(-2.1,2.1)) + 
  labs(x="-log(FDR q value)", y="Genesets", title="T cell & Lymphoma Genesets") +
  xlim(0,5.1)

```
