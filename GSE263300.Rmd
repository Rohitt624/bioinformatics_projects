---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r libraries, results='hide'}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(biomaRt)
library(pheatmap)
library(fgsea)
library(patchwork)
library(scales)
library(ggbreak)
library(ggcyto)
library(DESeq2)
options(future.globals.maxSize = 5000 * 1024^2)
setwd("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/MDS Project/RNA Seq/GSE263300/")

run_gsea <- function(markers, gmt_path, output_gsea) {
rnk <- setNames(markers$avg_log2FC, rownames(markers))
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 10, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
}

run_gsea_seu <- function(markers, gmt_path, output_gsea) {
rnk <- setNames(markers$avg_log2FC, markers$gene)
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 10, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
}

EnsIDReplace2 <- function(input, output){
  gene_mapping <- read.csv("C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/Ensembl_labels.csv")
  rna <- input
  rnanames <- rownames(rna)
  id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
  rnaname <- character(nrow(rna))
  for (i in seq_len(nrow(rna))) {
    ensembl_id <- rownames(rna)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
  rnaname[rnaname == ""] <- NA
  
  rownames(rna) <- rnaname
  output <- rna
  rm(gene_mapping, id_list, ensembl_id, i, rnaname)
}
```

```{r load data}
expr <- read.csv("expression_matrix.csv", row.names = 1)
cell.meta <- read.csv("cell_metadata.csv", row.names = 1)
so <- CreateSeuratObject(counts = expr, meta.data = cell.meta)
rm(expr, cell.meta)
```

```{r Process SO}
so <- NormalizeData(so)
so <- FindVariableFeatures(so)
so <- ScaleData(so)
so <- RunPCA(so)
so <- FindNeighbors(so, dims = 1:30)
so <- FindClusters(so, resolution = 0.8)
so <- RunUMAP(so, dims = 1:30)
```

seuratobject rdata file has already run through this point

```{r Visualize}
DimPlot(ery, group.by = "label")
VlnPlot(ery, features = c("CD44"), split.by = "dataset")
VlnPlot(so, features = c("MAP3K7"), split.by = "dataset")

DoHeatmap(
  ery, 
  features = c("SLAMF1", "ENG", "TFRC", "ITGA2B"), 
  group.by = "seurat_clusters", 
  split.by = "dataset"
)

# Create a new metadata column with combined identity
ery$cluster_dataset <- paste0("Cluster", ery$seurat_clusters, "_", ery$dataset)

# Now use that column name in AverageExpression
avg_exp <- AverageExpression(
  ery,
  features = c("SLAMF1", "ENG", "TFRC", "ITGA2B, CD44"),
  group.by = "cluster_dataset"
)$RNA

# Convert to a tidy dataframe
library(tibble)
library(tidyr)
avg_exp_df <- avg_exp %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column("cluster_dataset") %>%
  separate(cluster_dataset, into = c("cluster", "dataset"), sep = "_")

head(avg_exp_df)

heatmap_df <- avg_exp_df %>%
  pivot_longer(
    cols = c("SLAMF1", "ENG", "TFRC", "ITGA2B"),
    names_to = "gene",
    values_to = "avg_expression"
  )

# Rescale expression within each gene (0â€“1 per gene)
heatmap_df <- heatmap_df %>%
  group_by(gene) %>%
  mutate(scaled_expression = scales::rescale(avg_expression)) %>%
  ungroup()

# Heatmap with independent scales per gene
ggplot(heatmap_df, aes(x = cluster, y = dataset, fill = scaled_expression)) +
  geom_tile(color = "white") +
  facet_wrap(~gene, scales = "free_x") +
  scale_fill_gradient(low = "white", high = "red") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank()
  )

# Define genes of interest
genes <- c("SLAMF1", "ENG", "TFRC", "ITGA2B")

# Create cluster-dataset identifier
so$cluster_dataset <- paste0("Cluster", so$seurat_clusters, "_", so$dataset)

# Get average expression per cluster-dataset
avg_exp <- AverageExpression(
  so,
  features = genes,
  group.by = "cluster_dataset"
)$RNA

# Make sure rows = cluster-dataset, cols = genes
scores <- as.data.frame(t(avg_exp))

# pheatmap
pheatmap(scores,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         scale = "row",   # normalize within each gene (row)
         color = colorRampPalette(c("blue", "white", "red"))(100),
         treeheight_row = 0,
         treeheight_col = 0,
         main = "Average Expression Heatmap",
         filename = "avg_expression_heatmap.png")
```

SLAMF1 = CD150
ENG = CD105
TFRC = CD71


```{r Cluster Identification}
deg <- FindAllMarkers(so)
write.csv(deg, "clustermarkers.csv")

hsc <- c("AVP", "HLF", "PROM1")
hspc <- c("CD34", "PROM1")
gmp <- c("MPO", "ELANE", "S100A8", "S100A9")
mep <- c("TFRC", "KLF1", "GATA1")
mk <- c("PF4", "ITGA2B", "GP9")
mast <- c("MITF", "KIT", "KRT1")
eobp <- c("IL3RA", "IL5RA", "FCER1A")
genesets <- list(hsc = hsc,
                 hspc = hspc,
                 gmp = gmp,
                 mep = mep,
                 mk = mk,
                 mast = mast,
                 eobp = eobp)

for (name in names(genesets)) {
  so <- AddModuleScore(so, features = list(genesets[[name]]), name = name)
}

cluster_ids <- levels(so$seurat_clusters)
scores <- sapply(names(genesets), function(name) {
  score_col <- paste0(name, "1")
  tapply(so[[score_col]][,1], so$seurat_clusters, mean)
})
scores <- as.data.frame(scores)
rownames(scores) <- cluster_ids

pheatmap(scores,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         scale = "row",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         treeheight_row = 0,
         treeheight_col = 0,
         main = "Module Score Heatmap",
         filename = "modulescoreheatmap.png")

so$label <- NA
so$label[so$seurat_clusters %in% c(2, 5, 14)] <- "HSC/HSPC"
so$label[so$seurat_clusters %in% c(12, 3, 10)] <- "MEP/Erythroid"
so$label[so$seurat_clusters %in% c(16, 18)] <- "MEP/MK"
so$label[so$seurat_clusters %in% c(13, 15, 4, 6)] <- "EoBP"
so$label[so$seurat_clusters %in% c(11, 19, 7)] <- "GMP"
so$label[so$seurat_clusters %in% c(8, 17, 1, 0, 9)] <- "Mast"
Idents(so) <- "label"

FeatureScatter(so, feature1 = c("MAP3K7"), feature2 = c("RIPK1")) + 
  scale_x_flowjo_biexp() + 
  scale_y_flowjo_biexp()
```

```{r subset and recluster erythroid}
ery <- subset(so, so$label == c("MEP/Erythroid"))
ery <- NormalizeData(ery)
ery <- FindVariableFeatures(ery)
ery <- ScaleData(ery)
ery <- RunPCA(ery)
ery <- FindNeighbors(ery, dims = 1:30)
ery <- FindClusters(ery, resolution = 0.8)
ery <- RunUMAP(ery, dims = 1:30)

DimPlot(ery, split.by = "dataset")

Idents(ery) <- "dataset"
erymarkers <- FindMarkers(ery, ident.1 = "SF3B1", ident.2 = "AAVS")

hsc <- subset(so, so$label == c("HSC/HSPC"))
hsc <- NormalizeData(hsc)
hsc <- FindVariableFeatures(hsc)
hsc <- ScaleData(hsc)
hsc <- RunPCA(hsc)
hsc <- FindNeighbors(hsc, dims = 1:30)
hsc <- FindClusters(hsc, resolution = 0.8)
hsc <- RunUMAP(hsc, dims = 1:30)

DimPlot(hsc, split.by = "label")

Idents(hsc) <- "dataset"
hscmarkers <- FindMarkers(hsc, ident.1 = "SF3B1", ident.2 = "AAVS")

write.csv(erymarkers, "sf3b1_ery_deg.csv")
write.csv(hscmarkers, "sf3b1_hsc_deg.csv")

Idents(ery) <- "seurat_clusters"
erydeg <- FindAllMarkers(ery)
Idents(hsc) <- "seurat_clusters"
hscdeg <- FindAllMarkers(hsc)

write.csv(erydeg, "clustermarker_ery.csv")
write.csv(hscdeg, "clustermarker_hsc.csv")
```

```{r sf3b1 deg}
run_gsea(hscmarkers, "reactome_go_gsea.gmt", "hsc_sf3b1_gsea.csv")
run_gsea(erymarkers, "reactome_go_gsea.gmt", "ery_sf3b1_gsea.csv")

```

```{r subset and recluster erythroid}
ery <- subset(so, so$label == c("HSC/HSPC", "MEP/Erythroid"))
ery <- NormalizeData(ery)
ery <- FindVariableFeatures(ery)
ery <- ScaleData(ery)
ery <- RunPCA(ery)
ery <- FindNeighbors(ery, dims = 1:30)
ery <- FindClusters(ery, resolution = 0.8)
ery <- RunUMAP(ery, dims = 1:30)

DimPlot(ery)
erydeg <- FindAllMarkers(ery)
```

```{r sf3b1 deg}
Idents(ery) <- "dataset"
sf3b1markers <- FindMarkers(ery, ident.1 = "SF3B1", ident.2 = "AAVS")
sf3b1markers <- subset(sf3b1markers, sf3b1markers$p_val_adj < 0.1)
run_gsea(sf3b1markers, "reactome_go_gsea.gmt", "ery_sf3b1_gsea.csv")
write.csv(sf3b1markers, "ery_sf3b1_degs.csv")
```


