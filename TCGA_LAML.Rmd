---
title: "TCGA-LAML"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r packages}
library(tidyverse)
library(DESeq2)
library(rnaseqGene)
library(pheatmap)
library(ggalt)
library(fgsea)
library(biomaRt)
library(ggVennDiagram)
library(VennDiagram)
library(ggrepel)
library(jsonlite)
library(stringr)
library(fs)
library(dplyr)
library(GSVA)

setwd("C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/TBK1 Project/RNAseq/TCGA-LAML/")

EnsIDReplace2 <- function(input){
  gene_mapping <- read.csv("C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/Ensembl_labels_human.csv")
  rnanames <- rownames(input)
  id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
  rnaname <- character(nrow(input))
  for (i in seq_len(nrow(input))) {
    ensembl_id <- rownames(input)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
  rnaname[rnaname == ""] <- NA
  
  rownames(input) <- make.names(rnaname, unique = TRUE)
  rm(gene_mapping, id_list, ensembl_id, i, rnaname)
}

run_gsea <- function(dds, condition1, condition2, gmt_path, output_gsea, output_deg) {
  res1 <- DESeq2::results(dds, 
                       contrast = c("condition", condition1, condition2),
                       independentFiltering = TRUE,
                       alpha = 0.1)
res1 <- subset(res1, padj < 0.1)
rnk <- setNames(res1$log2FoldChange, rownames(res1))
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
res1_filtered <- res1[complete.cases(res1), ]
write.csv(res1_filtered, output_deg)
}
```

```{r rename files}
# Path to your combined metadata file
meta_file <- "C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/TBK1 Project/RNAseq/TCGA-LAML/metadata.cart.2025-12-19.json"

# Path to the folder containing all the UUID subfolders
download_dir <- "C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/TBK1 Project/RNAseq/TCGA-LAML/downloads/"

# Load metadata
meta <- fromJSON(meta_file)

# Build mapping: file_name → TCGA barcode
mapping <- tibble(
  file_name = meta$file_name,
  barcode   = sapply(meta$associated_entities, function(x) x$entity_submitter_id[1])
)

# Rename files inside UUID folders
for (i in seq_len(nrow(mapping))) {
  
  fname   <- mapping$file_name[i]
  barcode <- mapping$barcode[i]
  
  # Find the file recursively
  old_path <- dir(download_dir, pattern = paste0("^", fname, "$"),
                  recursive = TRUE, full.names = TRUE)
  
  if (length(old_path) == 1) {
    new_path <- file.path(dirname(old_path), paste0(barcode, ".tsv"))
    file_move(old_path, new_path)
    message("Renamed: ", fname, " → ", barcode)
  } else {
    message("Could not find file: ", fname)
  }
}


```

```{r merge into one counts matrix}
tsv_dir <- "C:/Users/rohit/OneDrive - Loyola University Chicago/Zhang Lab/TBK1 Project/RNAseq/TCGA-LAML/downloads/"
files <- list.files(tsv_dir, pattern = "\\.tsv$", full.names = TRUE)

read_unstranded <- function(f) {
  sample_id <- basename(f) |> str_remove("\\.tsv$")
  
  df <- read_tsv(
    f,
    comment = "#",
    col_types = cols(),
    progress = FALSE
  ) |> as_tibble()
  
  df <- df |> filter(!is.na(gene_name))
  
  df |>
    dplyr::select(gene_name, unstranded) |>
    dplyr::mutate(sample = sample_id)
}

# Read all files
long_df <- purrr::map_df(files, read_unstranded)

# Fix duplicates by summing counts
long_df_fixed <- long_df |>
  dplyr::group_by(gene_name, sample) |>
  dplyr::summarise(unstranded = sum(unstranded), .groups = "drop")

# Pivot to wide matrix
count_matrix <- long_df_fixed |>
  tidyr::pivot_wider(
    names_from = sample,
    values_from = unstranded
  ) |>
  dplyr::arrange(gene_name)

# Write to CSV
write.csv(count_matrix, "tcga_laml_counts.csv", row.names = FALSE)
```


```{r load data}
aml <- read.csv("tcga_laml_counts.csv", row.names = 1)
cd <- read.csv("coldata.csv")
dds <- DESeqDataSetFromMatrix(countData = aml, colData = cd, design = ~condition)
```

```{r order by tbk1}
dds <- estimateSizeFactors(dds)
norm <- counts(dds, normalized = TRUE) 
tbk1_vec <- norm["TBK1", ]

df <- data.frame( sample = names(tbk1_vec), tbk1 = as.numeric(tbk1_vec) ) 
df_ordered <- df %>% arrange(tbk1)

tbk1plot <- ggplot(df_ordered, aes(x = reorder(sample, tbk1), y = tbk1)) + 
  geom_col(fill = "steelblue") + 
  labs(title = "TBK1 Expression in TCGA-LAML", x = "Sample", y = "TBK1 Expression (normalized counts)") + 
  theme_bw() + 
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
tbk1plot

ggsave("tbk1_patientsamples_thirds.png", dpi = 600)


df <- data.frame(
  sample = names(tbk1_vec),
  tbk1 = as.numeric(tbk1_vec)
)

# Order by TBK1 expression
df_ordered <- df %>% arrange(tbk1)

# Compute quartile cutpoints (values)
qs <- quantile(df_ordered$tbk1, probs = c(0.33, 0.67))

# Compute the *index positions* where quartiles occur
q1_pos <- sum(df_ordered$tbk1 <= qs[1])
q2_pos <- sum(df_ordered$tbk1 <= qs[2])

df <- data.frame(
  sample = names(tbk1_vec),
  tbk1 = as.numeric(tbk1_vec)
)

# Order by TBK1 expression
df_ordered <- df %>% arrange(tbk1)

# Assign quartiles (Q1 = lowest, Q4 = highest)
df_ordered$quartile <- cut(
  df_ordered$tbk1,
  breaks = quantile(df_ordered$tbk1, probs = seq(0, 1, 1/3)),
  include.lowest = TRUE,
  labels = c("Q1", "Q2", "Q3")
)

colData <- df_ordered %>%
  dplyr::select(sample, quartile) %>%
  mutate(quartile = factor(quartile, levels = c("Q1", "Q2", "Q3")))

rownames(colData) <- colData$sample
aml <- aml[, rownames(colData)]

dds <- DESeqDataSetFromMatrix(
  countData = aml,
  colData = colData,
  design = ~ quartile
)

dds <- DESeq(dds)
vst <- vst(dds, blind=FALSE)
rescmp <- results(dds)
res_Q4_vs_Q1 <- results(dds, contrast = c("quartile", "Q3", "Q1"))


```

```{r gsea}
rnk <- res_Q4_vs_Q1$log2FoldChange
names(rnk) <- rownames(res_Q4_vs_Q1)
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways("humangseapathways.gmt")
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, "tbk1_gsea_newrnk_third.csv")
gseadf_subset <- subset(gseadf, padj < 0.25)
write.csv(gseadf_subset, "tbk1gseafiltered_third.csv")
res1_filtered <- res_Q4_vs_Q1[complete.cases(res_Q4_vs_Q1), ]
write.csv(res1_filtered, "tbk1_deg_third.csv")

rnk <- res_Q4_vs_Q1$log2FoldChange
names(rnk) <- rownames(res_Q4_vs_Q1)
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways("LSC.gmt")
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, "lsc_gsea_third.csv")
gseadf_subset <- subset(gseadf, padj < 0.25)
write.csv(gseadf_subset, "lscgseafiltered_third.csv")

```

```{r volcano plot}

res_df <- as.data.frame(res_Q4_vs_Q1)

res_df <- data.frame(
  gene = rownames(res_Q4_vs_Q1),
  log2FoldChange = as.numeric(res_Q4_vs_Q1$log2FoldChange),
  padj = as.numeric(res_Q4_vs_Q1$padj),
  pvalue = as.numeric(res_Q4_vs_Q1$pvalue),
  stat = as.numeric(res_Q4_vs_Q1$stat),
  stringsAsFactors = FALSE
)

str(res_df)


res_df <- res_df %>%
  mutate(
    sig = case_when(
      padj <= 0.1 & log2FoldChange >0  ~ "Up",
      padj <= 0.1 & log2FoldChange <0 ~ "Down",
      TRUE ~ "NS"
    )
  )

top10_up <- res_df %>%
  filter(sig == "Up") %>%
  arrange(pvalue) %>%
  head(10)

top10_down <- res_df %>%
  filter(sig == "Down") %>%
  arrange(pvalue) %>%
  head(10)

leading_edge <- bind_rows(top10_up, top10_down)




volcano <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = sig), alpha = 0.8, size = 1.8) +
  scale_color_manual(
    values = c(
      "Up" = "red",
      "Down" = "blue",
      "NS" = "gray70"
    )
  ) +
  geom_hline(yintercept = -log10(0.1), linetype = "dashed", color = "black") +
  labs(
    title = "TBK1 High vs Low",
    x = "log2 Fold Change",
    y = "-log10 Adjusted p-value",
    color = "Direction"
  ) +
  theme_bw(base_size = 12) + 
  geom_text_repel(
    data = leading_edge,
    aes(label = gene), 
    size = 3, 
    max.overlaps = Inf, 
    box.padding = 0.4, 
    point.padding = 0.2, 
    segment.color = "gray50")

volcano

ggsave("volcano_tbk1.png", volcano, dpi = 600)

```

```{r broad correlations}
# Use apply over rows, return a list of results
cor_list <- apply(norm, 1, function(gene_expr) {
  test <- cor.test(gene_expr, tbk1_vec,
                   method = "spearman",
                   use = "pairwise.complete.obs")
  data.frame(cor = test$estimate,
             pval = test$p.value)
})

# Bind results into a single data frame
cor_df <- do.call(rbind, cor_list)

# Add gene names
cor_df$gene <- rownames(norm)

# Reorder columns
cor_df <- cor_df[, c("gene", "cor", "pval")]

head(cor_df, 20)

write.csv(cor_df, "tbk1_correlation.csv")

rnk <- cor_df$cor
names(rnk) <- rownames(cor_df)
rnk <- rnk[!is.na(rnk)]

gmt <- gmtPathways("humangseapathways.gmt")
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, "tbk1_gsea_cor.csv")
gseadf_subset <- subset(gseadf, padj < 0.25)
write.csv(gseadf_subset, "tbk1corgseafiltered.csv")

```

```{r plot correlations}
cor_df <- cor_df %>%
  mutate(
    sig = case_when(
      cor > 0  ~ "Up",
      cor < 0 ~ "Down",
      TRUE ~ "NS"
    )
  )

top10_up <- cor_df %>%
  filter(sig == "Up") %>%
  arrange(-cor) %>%
  head(11)

top10_down <- cor_df %>%
  filter(sig == "Down") %>%
  arrange(cor) %>%
  head(10)

leading_edge <- bind_rows(top10_up, top10_down)

scatter <- ggplot(cor_df, aes(x = -log10(pval), y = cor)) +
  geom_point(size = 3) + 
  scale_color_manual(
    values = c(
      "Up" = "red",
      "Down" = "blue",
      "NS" = "gray70"
    )
  ) +
  labs(
    title = "Correlation with TBK1",
    x = "-log(pval)",
    y = "Spearman Correlation"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  ) + 
  geom_text_repel(
    data = leading_edge,
    aes(label = gene), 
    size = 3, 
    max.overlaps = Inf, 
    box.padding = 0.6, 
    point.padding = 0.4, 
    segment.color = "gray50", 
    force = 2)
  
scatter

ggsave("genecorrelationscatter.png", scatter, dpi = 600)
```

```{r gsva}
gsvaPar <- gsvaParam(norm, gmt,"gsva")
res_gsva <- gsva(gsvaPar, verbose = TRUE)

cor_list <- apply(res_gsva, 1, function(gsva_scores) {
  test <- cor.test(gsva_scores, tbk1_vec,
                   method = "spearman",
                   use = "pairwise.complete.obs")
  data.frame(cor = test$estimate,
             pval = test$p.value)
})

# Combine into a single data frame
cor_df <- do.call(rbind, cor_list)

# Add gene set names
cor_df$geneset <- rownames(res_gsva)

# Reorder columns
cor_df <- cor_df[, c("geneset", "cor", "pval")]

# Inspect results
head(cor_df)


write.csv(cor_df, "tbk1_gsva_cor.csv")
cordf_subset <- subset(cor_df, pval < 0.1)
write.csv(cordf_subset, "tbk1corgsvafiltered.csv")
```

```{r gsva fab adjusted}
sample_ids <- gsub("\\.", "-", colnames(norm))        # convert to TCGA format
patient_ids <- substr(sample_ids, 1, 12)              # TCGA patient barcode

fab_lookup <- clinical[, c("cases.submitter_id", "diagnoses.fab_morphology_code")]
colnames(fab_lookup) <- c("patient_id", "FAB")

fab_vector <- fab_lookup$FAB[ match(patient_ids, fab_lookup$patient_id) ]
fab_factor <- factor(fab_vector)

cor_list_adj <- apply(res_gsva, 1, function(gsva_scores) {
  
  df_tmp <- data.frame(
    gsva = gsva_scores,
    tbk1 = tbk1_vec,
    fab  = fab_factor
  )
  
  fit <- lm(gsva ~ tbk1 + fab, data = df_tmp)
  
  tbk1_coef <- summary(fit)$coefficients["tbk1", "Estimate"]
  tbk1_pval <- summary(fit)$coefficients["tbk1", "Pr(>|t|)"]
  
  data.frame(
    coef = tbk1_coef,
    pval = tbk1_pval
  )
})

cor_list_adj <- apply(res_gsva, 1, function(gsva_scores) {
  
  df_tmp <- data.frame(
    gsva = gsva_scores,
    tbk1 = tbk1_vec,
    fab  = fab_factor
  )
  
  # Full model
  fit_full <- lm(gsva ~ tbk1 + fab, data = df_tmp)
  
  # Reduced model (FAB only)
  fit_red  <- lm(gsva ~ fab, data = df_tmp)
  
  # Extract TBK1 coefficient and p-value
  tbk1_coef <- summary(fit_full)$coefficients["tbk1", "Estimate"]
  tbk1_pval <- summary(fit_full)$coefficients["tbk1", "Pr(>|t|)"]
  
  # Compute partial R^2 for TBK1
  rss_full <- sum(residuals(fit_full)^2)
  rss_red  <- sum(residuals(fit_red)^2)
  r2_partial <- (rss_red - rss_full) / rss_red
  
  data.frame(
    coef = tbk1_coef,
    pval = tbk1_pval,
    r2   = r2_partial
  )
})

cor_df_adj <- do.call(rbind, cor_list_adj)
cor_df_adj$geneset <- rownames(res_gsva)
cor_df_adj <- cor_df_adj[, c("geneset", "coef", "pval")]

write.csv(cor_df_adj, "tbk1_gsva_fab_adjusted.csv")

cordf_subset_adj <- subset(cor_df_adj, pval < 0.1)
write.csv(cordf_subset_adj, "tbk1_gsva_fab_adjusted_filtered.csv")
```

```{r overlap}
tg_norm <- read.csv("tbk1gseafiltered.csv", row.names = 2)
tg_cor <- read.csv("tbk1corgseafiltered.csv", row.names = 2)
tgsva_cor <- read.csv("tbk1corgsvafiltered.csv", row.names = 1)

# Positive overlap: NES > 0 and correlation > 0
pos_enriched <- rownames(tg_norm)[tg_norm$NES > 0]
pos_enriched2 <- rownames(tg_cor)[tg_cor$NES > 0]
pos_correlated <- rownames(tgsva_cor)[tgsva_cor$cor > 0]
pos_overlap <- Reduce(intersect, list(pos_enriched2, pos_correlated))

# Negative overlap: NES < 0 and correlation < 0
neg_enriched <- rownames(tg_norm)[tg_norm$NES < 0]
neg_enriched2 <- rownames(tg_cor)[tg_cor$NES < 0]
neg_correlated <- rownames(tgsva_cor)[tgsva_cor$cor < 0]
neg_overlap <- Reduce(intersect, list(neg_enriched2, neg_correlated))


# Inspect results
cat("Positive overlap pathways:\n")
print(pos_overlap)

cat("\nNegative overlap pathways:\n")
print(neg_overlap)

write.csv(pos_overlap, "pos_overlap.csv")
write.csv(neg_overlap, "neg_overlap.csv")
```

```{r clinical datatable}
clinical <- read_tsv("clinical.tsv")

quartiles <- colData(dds) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("sample_id") %>%   # <-- different name
  mutate(
    sample_tcga = gsub("\\.", "-", sample_id),
    patient_id  = substr(sample_tcga, 1, 12)
  ) %>%
  dplyr::select(patient_id, sample_id, quartile)

clinical_subset <- clinical %>%
  dplyr::select(
    cases.submitter_id,
    cases.disease_type,
    demographic.age_at_index,
    demographic.days_to_death,
    diagnoses.days_to_last_follow_up,
    demographic.gender,
    demographic.race,
    demographic.vital_status,
    diagnoses.fab_morphology_code
  )

merged_table <- quartiles %>%
  left_join(
    clinical_subset,
    by = c("patient_id" = "cases.submitter_id")
  )

final_table <- merged_table %>%
  dplyr::select(
    patient_id,
    sample_id,
    quartile,
    cases.disease_type,
    demographic.age_at_index,
    demographic.days_to_death,
    diagnoses.days_to_last_follow_up,
    demographic.gender,
    demographic.race,
    demographic.vital_status,
    diagnoses.fab_morphology_code
  )

final_table <- final_table %>%
  dplyr::distinct(patient_id, .keep_all = TRUE)

write.csv(final_table, "clinicaldata_third.csv")
rm(quartiles, clinical_subset, merged_table)

```

```{r fab}
# Create the matrix
fab_tbk1 <- matrix(c(
  5, 14, 11, 11, 5, 2, 2,   # Low
  8, 12, 12, 2, 11, 3, 0,   # Mid
  2, 9, 15, 1, 13, 10, 0    # High
), nrow = 3, byrow = TRUE)

# Add row and column names
rownames(fab_tbk1) <- c("Low", "Mid", "High")
colnames(fab_tbk1) <- c("M0", "M1", "M2", "M3", "M4", "M5", "NotClassified")

# Run the test
chisq.test(fab_tbk1)

chisq.test(fab_tbk1, simulate.p.value = TRUE, B = 10000)
```

```{r gsea plot}
gsva <- read.csv("gsva_selected.csv")
gsva_plot <- ggplot(gsva, aes(x=cor, y=reorder(geneset, cor), fill = pval)) +
  geom_col(color = "black") + 
  theme(
    panel.background = element_rect(fill = "white"), 
    panel.border = element_rect(color = "black", fill = NA), 
    plot.title = element_text(hjust = 0.5), 
    axis.text=element_text(color="black", face="bold")
    ) +
  scale_fill_gradient2(low="red", mid="white", high="blue", midpoint= 0.05, limits=c(0, 0.1)) + 
  labs(x="Spearman Correlation with TBK1", y="Genesets", title="GSVA Analysis") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black", size = 1)
gsva_plot
  

celldeath <- read.csv("celldeath_pathways.csv")
cdplot <- ggplot(celldeath,  aes(x=NES, y=reorder(pathway, NES), fill = padj)) +
  geom_col(color = "black") + 
  theme(
    panel.background = element_rect(fill = "white"), 
    panel.border = element_rect(color = "black", fill = NA), 
    plot.title = element_text(hjust = 0.5), 
    axis.text=element_text(color="black", face="bold")
    ) +
  scale_fill_gradient2(low="red", mid="white", high="blue", midpoint= 0.25, limits=c(0, 0.5)) + 
  labs(x="Normalized Enrichment Score", y="Genesets", title="Cell Death Pathways") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black", size = 1)
cdplot


ggsave("gsva.png", gsva_plot, width = 10, dpi = 600)
ggsave("celldeathgsea2.png", cdplot, dpi = 600)

```