---
title: "GSE145491 CITE-Seq Analysis"
output: html_notebook
---

# Set Up

Loading in required packages
```{r}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(biomaRt)
options(future.globals.maxSize = 4000 * 1024^2)
```

Load the dataset and create Seurat Object with two assays

```{r}
data <- as.sparse(read.table(file = "C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/GSE145491_UMIsMatrix.txt.gz",
                               sep = "", header = TRUE, row.names = 1))
adtfeat <- c("CD9", "CD41", "CD48", "CD55", "CD105", "CD115", "CD135", "CD150", "CXCR4", "ESAM", "CD4")
adtmat <- data[adtfeat, ]
allfeat <- rownames(data)
rnafeat <- setdiff(allfeat, adtfeat)
rnamat <- data[rnafeat, ]
rm(data, adtfeat, allfeat)
```

Replace RNA Ensembl IDs with gene IDs (this part is still buggy, leaves some blank cells, and uses 40 gb of RAM. So skip it)
```{r}
ensembl <- useEnsembl(biomart = "genes")
listDatasets(ensembl)
mart <- useDataset("mmusculus_gene_ensembl", useMart("ensembl"))
gene_ids <- getBM(
  filters = "ensembl_gene_id",
  attributes = c("ensembl_gene_id", "mgi_symbol"),
  values = rnafeat,
  mart = mart
)

id_list <- split(gene_ids[["mgi_symbol"]], gene_ids[["ensembl_gene_id"]])
rnaname <- character(nrow(rnamat))
for (i in seq_len(nrow(rnamat))) {
  ensembl_id <- rownames(rnamat)[i]
  if (ensembl_id %in% names(id_list)) {
    rnaname[i] <- id_list[[ensembl_id]]
  } else{
    rnaname[i] <- ensembl_id
  }
}
rnaname[rnaname == ""] <- NA

rownames(rnamat) <- rnaname
rm(ensembl, gene_ids, id_list, mart, ensembl_id, i, rnaname)
rownames(rnamat) <- make.names(rnamat, unique = TRUE)

```

## Create Seurat Object
```{r}
seurat_object <- CreateSeuratObject(counts = rnamat)
seurat_object[["ADT"]] <- CreateAssay5Object(counts = adtmat)
rm(adtmat, rnamat, rnafeat)
Assays(seurat_object)
seurat_object <- NormalizeData(object = seurat_object, assay = "RNA")
seurat_object <- NormalizeData(object = seurat_object, assay = "ADT", method = "CLR")
```

Verify the features under each assay
```{r}
rownames(seurat_object[["ADT"]])
rownames(seurat_object[["RNA"]])
```

Test ADT data by choosing any two ADT features
```{r}
FeatureScatter(seurat_object, feature1 = "adt_CD41", feature2 = "adt_CD105")
```


Check that the default assay is what you want it to be. Subsequent lines of code will use the features in the default assay unless you specify the assay within the arguments.
```{r}
# List the current default assay
DefaultAssay(seurat_object)
#Change default assay
DefaultAssay(seurat_object) <- "RNA" #change it to either "RNA" or "ADT"
DefaultAssay(seurat_object)
```

The Key for each assay allows you to put that before your feature of interest to circumvent switching the default assay (this is especially helpful if you want to use something from each assay in the same line of code).
```{r}
Key(seurat_object[["RNA"]])
Key(seurat_object[["ADT"]])
```


### Process the RNA data
```{r}
seurat_object <- FindVariableFeatures(object = seurat_object)
seurat_object <- ScaleData(object = seurat_object)
seurat_object <- RunPCA(object =seurat_object)
seurat_object <- FindNeighbors(object =seurat_object, dims = 1:30)
seurat_object <- FindClusters(object =seurat_object)
seurat_object <- RunUMAP(object =seurat_object, dims = 1:30)
```

Display the UMAP
```{r}
DimPlot(seurat_object)
```

# Analysis Tools

## Visualization
### Visualize both RNA and protein side by side
```{r}
DefaultAssay(seurat_object) <- "ADT"
p1 <- FeaturePlot(seurat_object, "CD41", cols = c("lightgrey", "darkgreen")) + ggtitle("CD41 protein")
DefaultAssay(seurat_object) <- "RNA"
p2 <- FeaturePlot(seurat_object, "ENSMUSG00000034664") + ggtitle("Cd41 RNA")
# place plots side-by-side
p1 | p2
```

An alternative way to write that code using the Key
```{r}
p1 <- FeaturePlot(seurat_object, "adt_CD41", cols = c("lightgrey", "darkgreen")) + ggtitle("CD41 protein")
p2 <- FeaturePlot(seurat_object, "rna_ENSMUSG00000034664") + ggtitle("CD41 RNA")
p1|p2
```

### Similarly, to identify surface markers, you can make plots of ADT values the same way you can for RNA values.
```{r}
VlnPlot(seurat_object, "adt_ESAM")
```

### You can also FindMarkers for each assay
This block is currently written to identify markers in identifier 6.
```{r}
adt_markers <- FindMarkers(seurat_object, ident.1 = 6, assay = "ADT")
rna_markers <- FindMarkers(seurat_object, ident.1 = 6, assay = "RNA")

write.csv(adt_markers, "C:/Users/rthalla//OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/adtmarkers.csv")
write.csv(rna_markers, "C:/Users/rthalla//OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/rnamarkers.csv")
```

### Create ADT scatter plots while showing cluster

Can "gate" cells using HoverLocator and FeatureLocator
```{r}
adtscatter <- FeatureScatter(seurat_object, feature1 = "adt_CD150", feature2 = "adt_CD105")

```

### View relationship between protein and RNA
```{r}
FeatureScatter(seurat_object, feature1 = "adt_ESAM", feature2 = "rna_ENSMUSG00000001946")
```
