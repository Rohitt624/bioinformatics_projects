---
title: "GSE128761"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r libraries, results='hide'}
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(biomaRt)
library(pheatmap)
library(fgsea)
library(patchwork)
options(future.globals.maxSize = 4000 * 1024^2)
setwd("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/HPC GSE128761")

run_gsea <- function(markers, gmt_path, output_gsea) {
rnk <- setNames(markers$avg_log2FC, rownames(markers))
rnk <- rnk[!is.na(rnk)]
gmt <- gmtPathways(gmt_path)
gsea <- fgsea(pathways = gmt, stats = rnk, minSize = 15, maxSize = 500)
gseadf <- as.data.frame(gsea)
list_columns <- sapply(gseadf, is.list)
gseadf[list_columns] <- lapply(gseadf[list_columns], function(col) sapply(col, paste, collapse = ";"))
write.csv(gseadf, output_gsea)
}

EnsIDReplace2 <- function(input, output){
  gene_mapping <- read.csv("C:/Users/rthalla/OneDrive - Loyola University Chicago/Zhang Lab/RNASeq/Cite-seq/GSE145491/Ensembl_labels.csv")
  rna <- input
  rnanames <- rownames(rna)
  id_list <- setNames(gene_mapping$gene_name, gene_mapping$gene_id)
  rnaname <- character(nrow(rna))
  for (i in seq_len(nrow(rna))) {
    ensembl_id <- rownames(rna)[i]
    if (ensembl_id %in% names(id_list)) {
      rnaname[i] <- id_list[[ensembl_id]]
    } else{
      rnaname[i] <- ensembl_id
    }
  }
  rnaname[rnaname == ""] <- NA
  
  rownames(rna) <- rnaname
  output <- rna
  rm(gene_mapping, id_list, ensembl_id, i, rnaname)
}
```

``` {r Load Seurat Object and Cluster}
data <- Read10X(data.dir = "Data/")
so <- CreateSeuratObject(counts = data)
so <- NormalizeData(so)
so <- FindVariableFeatures(so)
so <- ScaleData(so)
so <- RunPCA(so)
so <- FindNeighbors(so, dims = 1:30)
so <- FindClusters(so)
so <- RunUMAP(so, dims = 1:30)
rm(data)
```

```{r}
DimPlot(so, group.by = c("orig.ident"))

FeaturePlot(so, features = c("Ctnnal1"))
```


```{r Bar Chart}
aCat <- FetchData(so, vars = c("seurat_clusters", "Ctnnal1"))
aCat <- data.frame(Cell = rownames(aCat), Cluster = aCat$seurat_clusters, aCat = aCat$Ctnnal1)
aCat <- aCat[order(aCat$Cluster),]
aCat$Cell <- factor(aCat$Cell, levels = aCat$Cell)

aCatbar <- ggplot(aCat, aes(x = Cell, y = aCat, fill = as.factor(Cluster))) + 
    geom_bar(stat = "identity", width = 1) +
  theme(
    axis.text = element_blank(), 
    axis.title = element_blank(), 
    axis.ticks = element_blank(), 
    legend.position = "none",
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1)
  )
 

cd9 <- FetchData(seurat_object, vars = c("seurat_clusters", "adt_CD9"))
cd9 <- data.frame(Cell = rownames(cd9), Cluster = cd9$seurat_clusters, CD9 = cd9$adt_CD9)
cd9 <- cd9[order(cd9$Cluster),]
cd9$Cell <- factor(cd9$Cell, levels = cd9$Cell)

cd9bar <- ggplot(cd9, aes(x = Cell, y = CD9, fill = as.factor(Cluster))) + 
    geom_bar(stat = "identity") + 
  theme(
    axis.text = element_blank(), 
    axis.title = element_blank(), 
    axis.ticks = element_blank(), 
    legend.position = "none",
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1)
  )

barchart <- aCatbar / cd9bar

aCatbar

barchart  

```